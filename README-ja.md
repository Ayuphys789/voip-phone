# 📞 VoIP Phone - C言語による実装

C言語、GTK4、PortAudio、およびSpeexDSPライブラリを基盤として構築された、高機能なVoIP（Voice over IP）電話アプリケーションです。本アプリケーションはP2P（ピアツーピア）方式を採用し、低遅延かつ高品質な双方向の音声通話機能を提供します。

リアルタイム音声通信に要求される主要な技術要素（低遅延I/O、ネットワークパケット処理、音響信号処理）を、堅牢なマルチスレッドアーキテクチャ上で実現しています。

## ✨ 技術仕様

本アプリケーションは、快適な通話を実現するために以下の機能を実装しています。

* **GUI (GTK4):**

  * 接続先情報の入力と、通話状態の制御を行うための基本的なUIを提供します。

* **クロスプラットフォーム音声I/O (PortAudio):**

  * OSのオーディオサブシステムを抽象化し、低遅延な音声データの入出力を実現します。

  * コールバックベースの処理モデルを採用し、リアルタイム性が要求される音声処理の基盤を担います。

* **リアルタイム信号処理:**

  * **アコースティックエコーキャンセレーション (AEC):** SpeexDSPライブラリ (`libspeexdsp`) を利用し、適応フィルタを用いて音響エコーを抑制します。

  * **ノイズゲート:** マイク入力信号のRMS（二乗平均平方根）を算出し、設定された閾値を下回る信号を無音化することで、背景定常ノイズを低減します。

  * **ゲイン制御:** 送信音声に対し、線形なゲイン係数を乗算することで音量を調整します。クリッピングを防止するための飽和処理も実装しています。

  * **レベルメーター:** マイク入力のRMSレベルをGUIのプログレスバーで可視化します。

* **ネットワークプロトコル (UDP):**

  * 低遅延なデータ転送を実現するため、トランスポート層プロトコルとしてUDPを採用しています。

  * 送受信される音声データは、シーケンス番号を含むカスタム`AudioPacket`構造体にカプセル化されます。

* **通信品質の確保:**

  * **ジッターバッファ:** 受信パケットのネットワーク遅延揺らぎを吸収するための固定長ジッターバッファを実装。シーケンス番号に基づきパケットを並べ替え、再生タイミングを平滑化します。

  * **パケットロスへの対応:** ジッターバッファにおいて期待されるパケットが欠損していた場合（パケットロス）、その区間に無音データを挿入します。これはパケットロスに対応する最も基本的な処理であり、音声の途切れは発生しますが、予期せぬノイズの発生を防ぎ、プログラムの安定した動作を確保します。

* **補助機能:**

  * **通話時間タイマー:** 通信確立（最初のパケット受信）をトリガーとして、通話経過時間を表示します。

## 📦 依存関係とビルド環境

本アプリケーションのビルドには、以下の開発者向けパッケージが必要です。

| ライブラリ | Ubuntu / Debian系でのパッケージ名 | macOS (Homebrew)でのパッケージ名 | 役割 | 
| :--- | :--- | :--- | :--- | 
| **GTK4** | `libgtk-4-dev` | `gtk4` | GUIツールキット | 
| **PortAudio** | `portaudio19-dev` | `portaudio` | 音声I/O | 
| **SpeexDSP** | `libspeexdsp-dev` | `speexdsp` | AEC / 音声処理 | 
| **(その他)** | `build-essential` | `pkg-config` | コンパイルツール | 

#### インストールコマンド例

**Ubuntu / Debian系:**
```bash
sudo apt-get update
sudo apt-get install build-essential libgtk-4-dev portaudio19-dev libspeexdsp-dev
```

**macOS (Homebrew):**
```bash
brew install gtk4 portaudio speexdsp pkg-config
```

## 🛠️ ビルド手順

リポジトリに含まれる`Makefile`を使用してビルドを実行します。
```bash
make
```
上記コマンドにより、`bin/voip_phone` に実行可能ファイルが生成されます。

*(手動コンパイルの場合)*
```bash
mkdir -p bin
gcc src/voip_phone.c -o bin/voip_phone `pkg-config --cflags --libs gtk4 speexdsp` -pthread -lportaudio -lm
```

## 📂 リポジトリ構成

```
voip-phone/
├── .gitignore
├── LICENSE
├── Makefile
├── README.md
├── README-ja.md
│
├── bin/
│   └── voip_phone
│
└── src/
    └── voip_phone.c
```

## 💻 アーキテクチャ

本システムは、責務の分離とリアルタイム性の確保を目的としたマルチスレッドアーキテクチャを採用しています。

#### 5.1. 主要スレッド

* **メインスレッド (GUIスレッド):**
  GTKのメインループを実行し、UIイベントの処理と描画のみを担当します。ブロッキング処理は行わず、応答性を維持します。

* **PortAudioコールバックスレッド:**
  オーディオデバイスから高優先度で呼び出されるリアルタイムスレッド。音声処理のパイプライン（AEC、ノイズゲート、ゲイン）を実行し、バッファを介して他スレッドと連携します。このスレッド内での重い処理やブロッキングI/Oは厳禁です。

* **ネットワーク送受信スレッド:**
  `sender_thread_func`および`receiver_thread_func`として実装された、低優先度のバックグラウンドスレッド。それぞれUDPソケットのI/Oに専念します。

#### 5.2. データフローとバッファリング

* **送信パス:**
  `マイク` → `PortAudioコールバック` (AEC/信号処理) → `送信リングバッファ` (スレッド間連携) → `送信スレッド` → `UDP送信`

* **受信パス:**
  `UDP受信` → `受信スレッド` → `ジッターバッファ` (順序整列/揺らぎ吸収) → `PortAudioコールバック` → `スピーカー`

この非同期設計により、UIの応答性と、リアルタイム性が要求される音声I/O、そしてブロッキングが発生しうるネットワークI/Oを分離しています。

## 🔧 主要な関数とデータ構造

#### 6.1. データ構造

* `AppState`: アプリケーション全体のグローバルな状態を管理する構造体。全スレッドから共有されるリソース（GUIウィジェット、ソケットディスクリプタ、各種ハンドル、共有フラグ等）を保持し、コールバック関数の`user_data`として渡されます。

* `AudioPacket`: UDPで送受信されるデータの基本単位。32ビットのシーケンス番号と固定長のPCMサンプル配列で構成されます。

* `JitterBuffer`: 受信側で使用。シーケンス番号に基づきパケットを順序付けし、再生タイミングを調整します。プライミング機能（一定数のパケットが溜まるまで再生を開始しない）と基本的なパケットロス補償（無音挿入）を実装しています。

* `RingBuffer`: 送信側で使用。PortAudioコールバックスレッド（プロデューサ）とネットワーク送信スレッド（コンシューマ）を疎結合にするための、シンプルな循環バッファです。

#### 6.2. 主要関数

* `pa_callback()`: PortAudioから呼び出される音声処理の核心部。マイク入力(`inputBuffer`)とスピーカー出力(`outputBuffer`)を処理します。AEC、ノイズゲート、ゲイン調整等のDSP処理はすべてこの関数内で実行されます。

* `sender_thread_func()`: 送信リングバッファから音声データを取り出し、`AudioPacket`としてカプセル化し、UDP送信するループ。

* `receiver_thread_func()`: UDPソケットから`AudioPacket`を受信し、ジッターバッファに投入するループ。

* `on_call_button_clicked()`: 通話開始時のセットアップシーケンス。ソケットの生成、PortAudioおよびSpeexDSPの初期化、ネットワークスレッドの起動を行います。

* `on_hangup_button_clicked()`: 通話終了時のシャットダウンシーケンス。スレッドの停止トリガー（`is_running`フラグ）を設定し、確保した全リソース（ソケット、PortAudio、SpeexDSP、バッファ）を安全に解放します。

## 📜 ライセンス

本プロジェクトは [MITライセンス](LICENSE) の下で公開されています。

## 👋 作成者

三宅 智史 ([Ayuphys789](https://github.com/Ayuphys789))、
村中 正弘